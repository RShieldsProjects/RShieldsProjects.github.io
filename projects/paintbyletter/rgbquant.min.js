(function(){function t(t){if(t=t||{},this.method=t.method||2,this.colors=t.colors||256,this.initColors=t.initColors||4096,this.initDist=t.initDist||.01,this.distIncr=t.distIncr||.005,this.hueGroups=t.hueGroups||10,this.satGroups=t.satGroups||10,this.lumGroups=t.lumGroups||10,this.minHueCols=t.minHueCols||0,this.hueStats=this.minHueCols?new i(this.hueGroups,this.minHueCols):null,this.boxSize=t.boxSize||[64,64],this.boxPxls=t.boxPxls||2,this.palLocked=!1,this.dithKern=t.dithKern||null,this.dithSerp=t.dithSerp||!1,this.dithDelta=t.dithDelta||0,this.histogram={},this.idxrgb=t.palette?t.palette.slice(0):[],this.idxi32=[],this.i32idx={},this.i32rgb={},this.useCache=!1!==t.useCache,this.cacheFreq=t.cacheFreq||10,this.reIndex=t.reIndex||0==this.idxrgb.length,this.colorDist="manhattan"==t.colorDist?n:s,this.idxrgb.length>0){var r=this;this.idxrgb.forEach(function(t,i){var s=(-16777216|t[2]<<16|t[1]<<8|t[0])>>>0;r.idxi32[i]=s,r.i32idx[s]=i,r.i32rgb[s]=t})}}function i(t,i){this.numGroups=t,this.minCols=i,this.stats={};for(var r=-1;r<t;r++)this.stats[r]={num:0,cols:[]};this.groupsFull=0}t.prototype.sample=function t(i,r){if(this.palLocked)throw"Cannot sample additional images, palette already assembled.";var s=l(i,r);switch(this.method){case 1:this.colorStats1D(s.buf32);break;case 2:this.colorStats2D(s.buf32,s.width)}},t.prototype.reduce=function t(i,r,s,e){if(this.palLocked||this.buildPal(),s=s||this.dithKern,e=void 0!==e?e:this.dithSerp,r=r||1,s)var n=this.dither(i,s,e);else for(var h=l(i).buf32,o=h.length,n=new Uint32Array(o),a=0;a<o;a++){var $=h[a];n[a]=this.nearestColor($)}if(1==r)return new Uint8Array(n.buffer);if(2==r){for(var _=[],o=n.length,a=0;a<o;a++){var $=n[a];_[a]=this.i32idx[$]}return _}},t.prototype.dither=function(t,i,r){var s={FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]],Jarvis:[[7/48,1,0],[5/48,2,0],[3/48,-2,1],[5/48,-1,1],[7/48,0,1],[5/48,1,1],[3/48,2,1],[1/48,-2,2],[3/48,-1,2],[5/48,0,2],[3/48,1,2],[1/48,2,2]],Burkes:[[.25,1,0],[4/32,2,0],[2/32,-2,1],[4/32,-1,1],[.25,0,1],[4/32,1,1],[2/32,2,1],],Sierra:[[5/32,1,0],[3/32,2,0],[2/32,-2,1],[4/32,-1,1],[5/32,0,1],[4/32,1,1],[2/32,2,1],[2/32,-1,2],[3/32,0,2],[2/32,1,2],],TwoSierra:[[.25,1,0],[3/16,2,0],[1/16,-2,1],[2/16,-1,1],[3/16,0,1],[2/16,1,1],[1/16,2,1],],SierraLite:[[.5,1,0],[1/4,-1,1],[1/4,0,1],]};if(!i||!s[i])throw"Unknown dithering kernel: "+i;var e=s[i],n=l(t),h=n.buf32,o=n.width,a=n.height;h.length;for(var $=r?-1:1,_=0;_<a;_++){r&&($*=-1);for(var u=_*o,f=1==$?0:o-1,c=1==$?o:0;f!==c;f+=$){var d=u+f,x=h[d],p=255&x,g=(65280&x)>>8,v=(16711680&x)>>16,b=this.nearestColor(x),m=255&b,w=(65280&b)>>8,y=(16711680&b)>>16;if(h[d]=-16777216|y<<16|w<<8|m,!(this.dithDelta&&this.colorDist([p,g,v],[m,w,y])<this.dithDelta))for(var S=p-m,C=g-w,k=v-y,D=1==$?0:e.length-1,I=1==$?e.length:0;D!==I;D+=$){var P=e[D][1]*$,F=e[D][2],G=F*o;if(P+f>=0&&P+f<o&&F+_>=0&&F+_<a){var H=e[D][0],q=d+(G+P),A=255&h[q],E=(65280&h[q])>>8,L=(16711680&h[q])>>16,j=Math.max(0,Math.min(255,A+S*H)),z=Math.max(0,Math.min(255,E+C*H)),O=Math.max(0,Math.min(255,L+k*H));h[q]=-16777216|O<<16|z<<8|j}}}}return h},t.prototype.buildPal=function t(i){if(!this.palLocked&&(!(this.idxrgb.length>0)||!(this.idxrgb.length<=this.colors))){var r=this.histogram,s=function t(i,r){var s=[];for(var e in i)s.push(e);return f.call(s,function(t,s){return r?i[s]-i[t]:i[t]-i[s]})}(r,!0);if(0==s.length)throw"Nothing has been sampled, palette cannot be built.";switch(this.method){case 1:for(var e=this.initColors,n=r[s[e-1]],h=s.slice(0,e),o=e,a=s.length;o<a&&r[s[o]]==n;)h.push(s[o++]);this.hueStats&&this.hueStats.inject(h);break;case 2:var h=s}h=h.map(function(t){return+t}),this.reducePal(h),!i&&this.reIndex&&this.sortPal(),this.useCache&&this.cacheHistogram(h),this.palLocked=!0}},t.prototype.palette=function t(i,r){return this.buildPal(r),i?this.idxrgb:new Uint8Array(new Uint32Array(this.idxi32).buffer)},t.prototype.prunePal=function t(i){for(var r,s=0;s<this.idxrgb.length;s++)i[s]||(r=this.idxi32[s],this.idxrgb[s]=null,this.idxi32[s]=null,delete this.i32idx[r]);if(this.reIndex){for(var e=[],n=[],h={},s=0,o=0;s<this.idxrgb.length;s++)this.idxrgb[s]&&(r=this.idxi32[s],e[o]=this.idxrgb[s],h[r]=o,n[o]=r,o++);this.idxrgb=e,this.idxi32=n,this.i32idx=h}},t.prototype.reducePal=function t(i){if(this.idxrgb.length>this.colors){for(var r,s=i.length,e={},n=0,h=!1,o=0;o<s;o++)n!=this.colors||h||(this.prunePal(e),h=!0),r=this.nearestIndex(i[o]),n<this.colors&&!e[r]&&(e[r]=!0,n++);h||(this.prunePal(e),h=!0)}else{var a=i.map(function(t){return[255&t,(65280&t)>>8,(16711680&t)>>16,]}),s=a.length,$=s,_=this.initDist;if($>this.colors){for(;$>this.colors;){for(var u=[],o=0;o<s;o++){var l=a[o];if(i[o],l)for(var c=o+1;c<s;c++){var d=a[c],x=i[c];if(d){var p=this.colorDist(l,d);p<_&&(u.push([c,d,x,p]),delete a[c],$--)}}}_+=$>3*this.colors?this.initDist:this.distIncr}if($<this.colors){f.call(u,function(t,i){return i[3]-t[3]});for(var g=0;$<this.colors;)a[u[g][0]]=u[g][1],$++,g++}}for(var s=a.length,o=0;o<s;o++)a[o]&&(this.idxrgb.push(a[o]),this.idxi32.push(i[o]),this.i32idx[i[o]]=this.idxi32.length-1,this.i32rgb[i[o]]=a[o])}},t.prototype.colorStats1D=function t(i){for(var r,s=this.histogram,e=i.length,n=0;n<e;n++)(4278190080&(r=i[n]))>>24!=0&&(this.hueStats&&this.hueStats.check(r),r in s?s[r]++:s[r]=1)},t.prototype.colorStats2D=function t(i,r){var s=this.boxSize[0],e=this.boxSize[1],n=s*e,h=function t(i,r,s,e){for(var n=i%s,h=r%e,o=i-n,a=r-h,$=[],_=0;_<r;_+=e)for(var u=0;u<i;u+=s)$.push({x:u,y:_,w:u==o?n:s,h:_==a?h:e});return $}(r,i.length/r,s,e),o=this.histogram,a=this;h.forEach(function(t){var s,e=Math.max(Math.round(t.w*t.h/n)*a.boxPxls,2),h={};(function t(i,r,s){var e=i,n=e.y*r+e.x,h=(e.y+e.h-1)*r+(e.x+e.w-1),o=0,a=r-e.w+1,$=n;do s.call(this,$),$+=++o%e.w==0?a:1;while($<=h)})(t,r,function(t){(4278190080&(s=i[t]))>>24!=0&&(a.hueStats&&a.hueStats.check(s),s in o?o[s]++:s in h?++h[s]>=e&&(o[s]=h[s]):h[s]=1)})}),this.hueStats&&this.hueStats.inject(o)},t.prototype.sortPal=function t(){var i=this;this.idxi32.sort(function(t,r){var s=i.i32idx[t],e=i.i32idx[r],n=i.idxrgb[s],a=i.idxrgb[e],$=h(n[0],n[1],n[2]),_=h(a[0],a[1],a[2]),u=n[0]==n[1]&&n[1]==n[2]?-1:o($.h,i.hueGroups),f=(a[0]==a[1]&&a[1]==a[2]?-1:o(_.h,i.hueGroups))-u;if(f)return-f;var l,c,d=(l=+_.l.toFixed(2),l-(c=+$.l.toFixed(2),c));if(d)return-d;var x,p,g=(x=+_.s.toFixed(2),x-(p=+$.s.toFixed(2),p));if(g)return-g}),this.idxi32.forEach(function(t,r){i.idxrgb[r]=i.i32rgb[t],i.i32idx[t]=r})},t.prototype.nearestColor=function t(i){var r=this.nearestIndex(i);return null===r?0:this.idxi32[r]},t.prototype.nearestIndex=function t(i){if((4278190080&i)>>24==0)return null;if(this.useCache&&""+i in this.i32idx)return this.i32idx[i];for(var r,s=1e3,e=[255&i,(65280&i)>>8,(16711680&i)>>16,],n=this.idxrgb.length,h=0;h<n;h++)if(this.idxrgb[h]){var o=this.colorDist(e,this.idxrgb[h]);o<s&&(s=o,r=h)}return r},t.prototype.cacheHistogram=function t(i){for(var r=0,s=i[r];r<i.length&&this.histogram[s]>=this.cacheFreq;s=i[r++])this.i32idx[s]=this.nearestIndex(s)},i.prototype.check=function t(i){this.groupsFull==this.numGroups+1&&(this.check=function(){});var r=255&i,s=(65280&i)>>8,e=(16711680&i)>>16,n=r==s&&s==e?-1:o(h(r,s,e).h,this.numGroups),a=this.stats[n],$=this.minCols;a.num++,!(a.num>$)&&(a.num==$&&this.groupsFull++,a.num<=$&&this.stats[n].cols.push(i))},i.prototype.inject=function t(i){for(var r=-1;r<this.numGroups;r++)if(this.stats[r].num<=this.minCols)switch(_(i)){case"Array":this.stats[r].cols.forEach(function(t){-1==i.indexOf(t)&&i.push(t)});break;case"Object":this.stats[r].cols.forEach(function(t){i[t]?i[t]++:i[t]=1})}};var r=Math.sqrt(65025);function s(t,i){var s=i[0]-t[0],e=i[1]-t[1],n=i[2]-t[2];return Math.sqrt(.2126*s*s+.7152*e*e+.0722*n*n)/r}var e=54.213+.7152*255+18.411;function n(t,i){var r,s=Math.abs(i[0]-t[0]);return(.2126*s+.7152*Math.abs(i[1]-t[1])+.0722*Math.abs(i[2]-t[2]))/e}function h(t,i,r){var s,e,n,h,o,a,$,_,u;if(t/=255,i/=255,r/=255,o=((s=Math.max(t,i,r))+(e=Math.min(t,i,r)))/2,s==e)n=h=0;else{switch(a=s-e,h=o>.5?a/(2-s-e):a/(s+e),s){case t:n=(i-r)/a+(i<r?6:0);break;case i:n=(r-t)/a+2;break;case r:n=(t-i)/a+4}n/=6}return{h:n,s:h,l:($=t,_=i,Math.sqrt(.2126*$*$+.7152*_*_+.0722*(u=r)*u))}}function o(t,i){var r=1/i,s=r/2;if(t>=1-s||t<=s)return 0;for(var e=1;e<i;e++){var n=e*r;if(t>=n-s&&t<=n+s)return e}}function a(t){return t}function $(t){return t}function _(t){return Object.prototype.toString.call(t).slice(8,-1)}var u,f=(u="abcdefghijklmnopqrstuvwxyz","xyzvwtursopqmnklhijfgdeabc"==u.split("").sort(function(t,i){return~~(u.indexOf(i)/2.3)-~~(u.indexOf(t)/2.3)}).join(""))?Array.prototype.sort:function t(i){var r=_(this[0]);if("Number"==r||"String"==r){for(var s,e={},n=this.length,h=0;h<n;h++)e[s=this[h]]||0===e[s]||(e[s]=h);return this.sort(function(t,r){return i(t,r)||e[t]-e[r]})}var e=this.map(function(t){return t});return this.sort(function(t,r){return i(t,r)||e.indexOf(t)-e.indexOf(r)})};function l(t,i){var r,s,e,n,h,o;switch(_(t)){case"HTMLImageElement":(r=document.createElement("canvas")).width=t.naturalWidth,r.height=t.naturalHeight,(s=r.getContext("2d")).drawImage(t,0,0);case"Canvas":case"HTMLCanvasElement":r=r||t,s=s||r.getContext("2d");case"CanvasRenderingContext2D":s=s||t,r=r||s.canvas,e=s.getImageData(0,0,r.width,r.height);case"ImageData":i=(e=e||t).width,n="CanvasPixelArray"==_(e.data)?new Uint8Array(e.data):e.data;case"Array":case"CanvasPixelArray":n=n||new Uint8Array(t);case"Uint8Array":case"Uint8ClampedArray":n=n||t,h=new Uint32Array(n.buffer);case"Uint32Array":h=h||t,n=n||new Uint8Array(h.buffer),i=i||h.length,o=h.length/i}return{can:r,ctx:s,imgd:e,buf8:n,buf32:h,width:i,height:o}}this.RgbQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this);