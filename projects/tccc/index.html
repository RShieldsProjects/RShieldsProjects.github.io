<!DOCTYPE html>
<html>
  <head>
    <title>TC Chart Converter</title>
    <link rel="stylesheet" href="index.css">
    <script src="lib/midi-converter.js"></script>
    <!--
      init must always come first, than warnings,
      and the rest can be loaded in any order
    -->
    <script src="src/init.js"></script>
    <script src="src/warnings.js"></script>

    <script src="src/color.js"></script>
    <script src="src/generate.js"></script>
    <script src="src/import.js"></script>
    <script src="src/inputs.js"></script>
    <script src="src/midiToNotes.js"></script>
    <script src="src/preview.js"></script>
    <script src="src/readMidi.js"></script>
    <script src="src/save.js"></script>
    <script src="src/settings.js"></script>
  </head>
  <body>
    <!-- bruh I handwrote all of this -->
    <div class="bodycontainer">
      <h1>Trombone Champ Chart Converter</h1>

      <div id="midicontainer" class="container">
        <h2><label for="midifile">MIDI file</label></h2>
        <input type="file" id="midifile" name="midifile" accept=".mid">
        <table>
          <tr>
            <td><label for="clamppitch"><abbr title="Whether to clamp notes between midi pitches 47 and 73, the maximum range of vanilla Trombone Champ. If unchecked, generated notes may be unplayable.">Clamp Pitch</abbr></label></td>
            <td><input type="checkbox" id="clamppitch" name="clamppitch" checked></td>
          </tr>
          <tr>
            <td><label for="snap"><abbr title="What quantization snap to use for warning about unquantized notes. This should be a power of 2. Alternatively, setting this to 0 will ignore all quantization warnings. Triplets (snap 12) are recognized automatically, regardless.">Snap</abbr></label></td>
            <td><input type="number" id="snap" name="snap" min="0" max="192" value="32"></td>
          </tr>
        </table>
        <div id="midiwarnings" class="warnings"></div>
      </div>

      <div id="metadatacontainer" class="container">
        <h2>Metadata</h2>
        <h3><label for="importmetadatafile">Import from previous (optional)</label></h3>
        <input type="file" id="importmetadatafile" name="importmetadatafile" accept=".tmb">
        <button id="importmetadatabutton">Import</button>
        <table>
          <tr><td colspan="2"><h3>- Song info -</h3></td></tr>
          <tr>
            <td><label for="songname"><abbr title="Full song name, as shown in the lefthand info during song select">Song Name</abbr></label></td>
            <td><input type="text" id="songname" name="songname"></td>
          </tr>
          <tr>
            <td><label for="shortname"><abbr title="Short song name, as shown in the righthand song selector">Short Name</abbr></label></td>
            <td><input type="text" id="shortname" name="shortname"></td>
          </tr>
          <tr>
            <td><label for="artist"><abbr title="Composer or author of the song">Artist</abbr></label></td>
            <td><input type="text" id="artist" name="artist"></td>
          </tr>
          <tr>
            <td><label for="releaseyear"><abbr title="Year the song was released">Release Year</abbr></label></td>
            <td><input type="number" id="releaseyear" name="releaseyear" value="2022"></td>
          </tr>
          <tr>
            <td><label for="genre"><abbr title="Genre of the song">Genre</abbr></label></td>
            <td><input type="text" id="genre" name="genre"></td>
          </tr>
          <tr>
            <td><label for="description"><abbr title="Song description, as shown in the lefthand song info">Description</abbr></label></td>
            <td><input type="text" id="description" name="description"></td>
          </tr>
          <tr><td colspan="2"><h3>- Chart info -</h3></td></tr>
          <tr>
            <td><label for="bpm"><abbr title="Variable BPM and non-integer BPM are not supported">BPM</abbr></label></td>
            <td><input type="number" id="bpm" name="bpm" min="1" max="1000"></td>
          </tr>
          <tr>
            <td><label for="beatsperbar"><abbr title="How many measure lines to show in each bar. Usually 2 is fine for songs in 2/2 or 4/4 time and 3 is fine for songs in 3/4 or 6/8 time. For songs in other time signatures, this should usually be the number on the top of the time signature.">Beats Per Bar</abbr></label></td>
            <td><input type="number" id="beatsperbar" name="beatsperbar" value="2" min="1" max="20"></td>
          </tr>
          <tr>
            <td><label for="difficulty"><abbr title="Difficulty from 1 to 10 stars">Difficulty</abbr></label></td>
            <td><input type="number" id="difficulty" name="difficulty" value="5" min="1" max="10"></td>
          </tr>
          <tr>
            <td><label for="notespacing"><abbr title="The higher this is, the faster the chart will scroll and the fewer notes will be on the screen at once. If unsure, set this to 180 and adjust from there.">Note Spacing</abbr></label></td>
            <td><input type="number" id="notespacing" name="notespacing" min="1" max="1000" value="180"></td>
          </tr>
          <tr>
            <td><label for="notestartcolor"><abbr title="Color of the start of the note">Note Start Color</abbr></label></td>
            <td><input type="color" id="notestartcolor" name="notestartcolor" value="#ff3600"></td>
          </tr>
          <tr>
            <td><label for="noteendcolor"><abbr title="Color of the end of the note">Note End Color</abbr></label></td>
            <td><input type="color" id="noteendcolor" name="noteendcolor" value="#ffcc4c"></td>
          </tr>
          <tr><td colspan="2"><h3>- Other -</h3></td></tr>
          <tr>
            <td><label for="foldername"><abbr title="Name of the song folder, required for old versions of TrombLoader">Folder Name</abbr></label></td>
            <td><input type="text" id="foldername" name="foldername" placeholder="Auto"></td>
          </tr>
          <tr>
            <td><label for="songendpoint"><abbr title="The length of the song in measures. Leave this blank unless you need to manually set the endpoint.">Song Endpoint</abbr></label></td>
            <td><input type="number" id="songendpoint" name="songendpoint" placeholder="Auto"></td>
          </tr>
        </table>
      </div>

      <div>
        <h2>Preview</h2>
        <div id="previewcontainer">
          <canvas id="preview" height="200"></canvas>
        </div>
      </div>

      <div id="generatewarnings" class="warnings"></div>
      <button id="generatechart"><h2>Generate Chart</h2></button>

      <div class="info">
        <p>Converts a midi file (.mid) into a TrombLoader chart.</p>
        <p>
          Most of the instructions for how to make a chart are on the Trombone Champ modding Discord:<br>
          <a href="https://discord.gg/KVzKRsbetJ">https://discord.gg/KVzKRsbetJ</a>
        </p>
        <p>
          Usage:
          <ol>
            <li>Upload the midi above.</li>
            <li>
              Fill out the form
              <ul>
                <li>All fields must be filled in, except those in the Other section</li>
                <li>Only input whole numbers. Decimals are not guaranteed to work.</li>
                <li>Hover over the names of each field to see detailed info</li>
              </ul>
            </li>
            <li>Click Generate Chart. The result will be downloaded as song.tmb</li>
          </ol>
        </p>
        <p>
          Notes:
          <ul>
            <li>Midi notes should be in the range 47 to 73 to match the game. Any notes outside this range will likely be unplayable.</li>
            <li>Quantize your charts, the game hates unquantized notes</li>
            <li>Some midi editors use velocity 0 to indicate a note should turn off. This supports that. Don't otherwise set velocity to 0.</li>
            <li>Unlike Midi2TromboneChamp, this squashes all tracks and has no slide track.</li>
          </ul>
        </p>
        <p>
          Nyx's converter, which I have shamelessly stolen most of the parsing logic from, can be found at<br>
          <a href="https://github.com/NyxTheShield/Midi2TromboneChamp">https://github.com/NyxTheShield/Midi2TromboneChamp</a>
        </p>
      </div>

      <div>
      <p>Version history</p>
      <p>
        v1.5a:<br>
        Renamed "measure" to "beat"
      </p>
      <p>
        v1.5:<br>
        Added preview<br>
        Switched from vars to only lets and consts
      </p>
      <p>
        v1.4:<br>
        Load the midi eagerly instead of only at generate time<br>
        Format warnings better and let users hide them<br>
        Changed styling a bit<br>
        Split the code into many files
      </p>
      <p>
        v1.3a:<br>
        Added randomly generated folder names to fix a name collision issue
      </p>
      <p>
        v1.3:<br>
        Added metadata importing<br>
        Fixed an issue when a note ends at the same time as another starts<br>
        Moved warnings to be above the button to make them easier to see<br>
        Added placeholder for endpoint input<br>
        Changed default note spacing: previously BPM, now 180
      </p>
      <p>
        v1.2:<br>
        Added option to clamp notes<br>
        Added warnings for unsnapped notes<br>
        Treat midi start-note with velocity 0 as end-note<br>
        Added cleanup of object URLs
      </p>
      <p>
        v1.1:<br>
        Renamed from "MIDI to TMB" to "TCCC"<br>
        Fixed default colors<br>
        Added version history
      </p>
      <p>
        v1.0:<br>
        Initial release
      </p>
      </div>
    </div>
    <script>init();</script>
  </body>
</html>
